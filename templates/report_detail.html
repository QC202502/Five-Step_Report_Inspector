{% extends "base.html" %}

{% block title %}{{ report.title }} - 五步法研报检查器{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<style>
    /* 修复页面无限延长bug的内联样式 */
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* 确保表格不会溢出 */
    .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* 确保长文本内容不会溢出容器 */
    td, th, p, div {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* 控制Claude分析详情部分 */
    .claude-analysis {
        max-height: 600px;
        overflow-y: auto;
        word-break: break-word;
    }
    
    /* 预先定义进度条样式，避免模板语法在style标签中造成问题 */
    .progress-bar-success {
        background-color: #198754;
    }
    
    .progress-bar-info {
        background-color: #0dcaf0;
    }
    
    .progress-bar-warning {
        background-color: #ffc107;
    }
    
    .progress-bar-danger {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">首页</a></li>
                    <li class="breadcrumb-item active">研报详情</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">研报详情</h4>
                    <a href="{{ report.link }}" target="_blank" class="btn btn-light btn-sm">查看原文</a>
                </div>
                <div class="card-body">
                    <h2 class="mb-3">{{ report.title }}</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <strong>行业：</strong> <a href="/industry/{{ report.industry }}">{{ report.industry }}</a>
                        </div>
                        <div class="col-md-3">
                            <strong>评级：</strong> 
                            {% if report.rating == '买入' or report.rating == '强烈推荐' %}
                                <span class="badge bg-success">{{ report.rating }}</span>
                            {% elif report.rating == '增持' or report.rating == '推荐' %}
                                <span class="badge bg-primary">{{ report.rating }}</span>
                            {% elif report.rating == '中性' or report.rating == '持有' %}
                                <span class="badge bg-secondary">{{ report.rating }}</span>
                            {% elif report.rating == '减持' or report.rating == '卖出' %}
                                <span class="badge bg-danger">{{ report.rating }}</span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ report.rating }}</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <strong>发布机构：</strong> {{ report.org }}
                        </div>
                        <div class="col-md-3">
                            <strong>发布日期：</strong> {{ report.date }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <h3 class="mb-3">五步法分析结果</h3>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-4 analysis-card">
                                <div class="card-body five-step-header">
                                    <h4 class="mb-2">总体评分：<span class="five-step-score">{{ score }}%</span></h4>
                                    <p class="mb-2">{{ report.analysis.summary.evaluation }}</p>
                                    
                                    <!-- 使用后端预处理的样式类 -->
                                    <div class="progress mb-4" style="height: 25px;">
                                        <div class="progress-bar {{ progress_class }}" role="progressbar" 
                                             style="width: {{ score }}%" 
                                             aria-valuenow="{{ score }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ score }}%
                                        </div>
                                    </div>
                                    
                                    {% if report.analysis_method == "Claude增强" and report.analysis.summary.one_line_summary %}
                                    <div class="mt-3">
                                        <h5>一句话总结：</h5>
                                        <p class="one-line-summary">{{ report.analysis.summary.one_line_summary }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 analysis-card">
                                <div class="card-body radar-chart-container" style="height: 300px;">
                                    <canvas id="radarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover analysis-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 10%">分析步骤</th>
                                            <th style="width: 10%" class="text-center">是否应用</th>
                                            <th style="width: 20%">匹配关键词</th>
                                            <th style="width: 40%">证据</th>
                                            <th style="width: 20%">说明</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for step, info in steps_stats.items() %}
                                        <tr>
                                            <td><strong>{{ step }}</strong></td>
                                            <td class="text-center">
                                                {% if info.found %}
                                                    <span class="badge bg-success">✓</span>
                                                {% else %}
                                                    <span class="badge bg-danger">✗</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if info.keywords %}
                                                    {% for keyword in info.keywords %}
                                                        <span class="badge keyword-badge me-1">{{ keyword }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">无匹配关键词</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-wrap">
                                                {% if info.evidence %}
                                                    <ul class="mb-0 ps-3">
                                                        {% for evidence in info.evidence %}
                                                            <li class="evidence-item">{{ evidence }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span class="text-muted">无证据</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ info.description }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if report.analysis_method == "Claude增强" and report.full_analysis %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Claude增强分析详情</h5>
                </div>
                <div class="card-body">
                    <div class="claude-analysis p-3 bg-light rounded">
                        {{ report.full_analysis|safe|replace('\n', '<br>')|replace('## ', '<h5>')|replace('#', '</h5>')|replace('|', '&#124;') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">报告摘要</h5>
                </div>
                <div class="card-body">
                    <div class="report-full-content p-3 bg-light rounded">{{ report.full_content if report.full_content else report.content_preview }}</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // 使用JSON.parse避免模板语法在JavaScript中的问题
    document.addEventListener('DOMContentLoaded', function() {
        var stepsData = {{ radar_data|tojson }};
        var steps = {{ steps_order|tojson }};
        
        // 绘制雷达图
        drawRadarChart('radarChart', stepsData, steps);
    });
</script>
{% endblock %}
