{% extends "base.html" %}

{% block title %}研报分析 - {{ report.title }}{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<style>
    /* 基础响应式布局样式 */
    .container-fluid {
        width: 100%;
        padding: 0 15px;
        margin: 0 auto;
    }
    
    /* 小屏幕设备 (手机, 768px 以下) */
    @media (max-width: 767.98px) {
        .container-fluid {
            max-width: 100%;
            padding: 0 10px;
        }
    }
    
    /* 中等屏幕设备 (平板, 768px 到 991.98px) */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .container-fluid {
            max-width: 95%;
        }
    }
    
    /* 大屏幕设备 (桌面, 992px 到 1199.98px) */
    @media (min-width: 992px) and (max-width: 1199.98px) {
        .container-fluid {
            max-width: 90%;
        }
    }
    
    /* 超大屏幕设备 (大桌面, 1200px 以上) */
    @media (min-width: 1200px) {
        .container-fluid {
            max-width: 1800px;
        }
    }
    
    /* 侧边栏样式 */
    .sidebar-left, .sidebar-right {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .sidebar-content {
        position: sticky;
        top: 20px;
    }
    
    /* 小屏幕上的侧边栏样式 */
    @media (max-width: 991.98px) {
        .sidebar-left, .sidebar-right {
            position: fixed;
            top: 0;
            height: 100%;
            background-color: white;
            z-index: 1050;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            padding: 20px;
        }
        
        .sidebar-left {
            left: 0;
            transform: translateX(-100%);
            width: 280px;
        }
        
        .sidebar-right {
            right: 0;
            transform: translateX(100%);
            width: 280px;
        }
        
        .sidebar-left.show {
            transform: translateX(0);
        }
        
        .sidebar-right.show {
            transform: translateX(0);
        }
    }
    
    /* 侧边栏背景遮罩 */
    .sidebar-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1040;
        display: none;
    }
    
    .sidebar-backdrop.show {
        display: block;
    }
    
    /* 修复页面无限延长bug的内联样式 */
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* 确保表格不会溢出 */
    .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* 确保长文本内容不会溢出容器 */
    td, th, p, div {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* 控制Claude分析详情部分 */
    .claude-analysis {
        max-height: 600px;
        overflow-y: auto;
        word-break: break-word;
    }
    
    /* 预先定义进度条样式，避免模板语法在style标签中造成问题 */
    .progress-bar-success {
        background-color: #198754;
    }
    
    .progress-bar-info {
        background-color: #0dcaf0;
    }
    
    .progress-bar-warning {
        background-color: #ffc107;
    }
    
    .progress-bar-danger {
        background-color: #dc3545;
    }
    
    /* 响应式字体和间距 */
    @media (max-width: 767.98px) {
        body {
            font-size: 14px;
        }
        
        h1 {
            font-size: 1.8rem;
        }
        
        h2 {
            font-size: 1.5rem;
        }
        
        .card {
            margin-bottom: 1rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .report-content p {
            margin-bottom: 1em;
        }
    }
    
    /* 中等屏幕上的调整 */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .card-body {
            padding: 1rem;
        }
        
        .report-content p {
            margin-bottom: 1.2em;
        }
    }
    
    /* 响应式表格 */
    .table-responsive-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .table-scroll-hint {
        display: none;
        text-align: center;
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    @media (max-width: 767.98px) {
        .table-scroll-hint {
            display: block;
        }
    }
    
    /* 在小屏幕上调整元素顺序 */
    @media (max-width: 767.98px) {
        .mobile-order-1 {
            order: 1;
        }
        .mobile-order-2 {
            order: 2;
        }
        .mobile-order-3 {
            order: 3;
        }
    }
    
    /* 图表容器高度 */
    @media (max-width: 767.98px) {
        .chart-container {
            height: 200px;
        }
    }
    
    @media (min-width: 768px) {
        .chart-container {
            height: 300px;
        }
    }
    
    /* 关闭按钮 */
    .sidebar-close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        font-size: 1.5rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="sidebar-backdrop"></div>
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">首页</a></li>
            <li class="breadcrumb-item active" aria-current="page">研报详情</li>
        </ol>
    </nav>

    <!-- 五维度分析卡片（顶部位置）-->
    {% if deepseek_analysis %}
    <div class="row mb-4">
        <!-- 信息维度卡片 -->
        <div class="col-md-6 col-xl-2 col-lg-4 mb-3">
            <div class="card h-100 analysis-dimension-card info-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <h5 class="mb-0">信息</h5>
                        </div>
                        <span class="badge score-badge">{{ deepseek_analysis.steps.信息.step_score }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="dimension-description">{{ deepseek_analysis.steps.信息.description | safe }}</p>
                    {% if deepseek_analysis.steps.信息.framework_summary %}
                    <div class="framework-summary mt-2">
                        <h6>框架梳理</h6>
                        <div class="small">{{ deepseek_analysis.steps.信息.framework_summary | safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 逻辑维度卡片 -->
        <div class="col-md-6 col-xl-2 col-lg-4 mb-3">
            <div class="card h-100 analysis-dimension-card logic-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-project-diagram me-2"></i>
                            <h5 class="mb-0">逻辑</h5>
                        </div>
                        <span class="badge score-badge">{{ deepseek_analysis.steps.逻辑.step_score }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="dimension-description">{{ deepseek_analysis.steps.逻辑.description | safe }}</p>
                    {% if deepseek_analysis.steps.逻辑.framework_summary %}
                    <div class="framework-summary mt-2">
                        <h6>框架梳理</h6>
                        <div class="small">{{ deepseek_analysis.steps.逻辑.framework_summary | safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 超预期维度卡片 -->
        <div class="col-md-6 col-xl-2 col-lg-4 mb-3">
            <div class="card h-100 analysis-dimension-card expectation-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line me-2"></i>
                            <h5 class="mb-0">超预期</h5>
                        </div>
                        <span class="badge score-badge">{{ deepseek_analysis.steps.超预期.step_score }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="dimension-description">{{ deepseek_analysis.steps.超预期.description | safe }}</p>
                    {% if deepseek_analysis.steps.超预期.framework_summary %}
                    <div class="framework-summary mt-2">
                        <h6>框架梳理</h6>
                        <div class="small">{{ deepseek_analysis.steps.超预期.framework_summary | safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 催化剂维度卡片 -->
        <div class="col-md-6 col-xl-3 col-lg-6 mb-3">
            <div class="card h-100 analysis-dimension-card catalyst-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-bolt me-2"></i>
                            <h5 class="mb-0">催化剂</h5>
                        </div>
                        <span class="badge score-badge">{{ deepseek_analysis.steps.催化剂.step_score }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="dimension-description">{{ deepseek_analysis.steps.催化剂.description | safe }}</p>
                    {% if deepseek_analysis.steps.催化剂.framework_summary %}
                    <div class="framework-summary mt-2">
                        <h6>框架梳理</h6>
                        <div class="small">{{ deepseek_analysis.steps.催化剂.framework_summary | safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 结论维度卡片 -->
        <div class="col-md-6 col-xl-3 col-lg-6 mb-3">
            <div class="card h-100 analysis-dimension-card conclusion-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-flag-checkered me-2"></i>
                            <h5 class="mb-0">结论</h5>
                        </div>
                        <span class="badge score-badge">{{ deepseek_analysis.steps.结论.step_score }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="dimension-description">{{ deepseek_analysis.steps.结论.description | safe }}</p>
                    {% if deepseek_analysis.steps.结论.framework_summary %}
                    <div class="framework-summary mt-2">
                        <h6>框架梳理</h6>
                        <div class="small">{{ deepseek_analysis.steps.结论.framework_summary | safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 小屏幕上的侧边栏切换按钮 -->
    <div class="d-lg-none mb-3">
        <div class="d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary" id="toggleLeftSidebar">
                <i class="fas fa-list"></i> 目录导航
            </button>
            <button class="btn btn-sm btn-outline-primary" id="toggleRightSidebar">
                <i class="fas fa-chart-pie"></i> 分析结果
            </button>
        </div>
    </div>

    <div class="row">
        <!-- 左侧边栏 -->
        <div class="col-lg-3 sidebar-left d-none d-lg-block">
            <div class="sidebar-content" id="leftSidebar">
                <div class="d-lg-none">
                    <span class="sidebar-close" id="closeLeftSidebar">&times;</span>
                </div>
                
                <!-- 研报基本信息 -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">研报信息</h5>
                    </div>
                    <div class="card-body">
                        <h6>{{ report.title }}</h6>
                        <p class="mb-1"><strong>机构：</strong> {{ report.org }}</p>
                        <p class="mb-1"><strong>日期：</strong> {{ report.date }}</p>
                        <p class="mb-1"><strong>评级：</strong> {{ report.rating }}</p>
                        <p class="mb-1"><strong>股票：</strong> {{ report.stock_name }} ({{ report.stock_code }})</p>
                    </div>
                </div>
                
                <!-- 目录导航 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">目录导航</h5>
                    </div>
                    <div class="card-body p-2">
                        <div id="toc" class="list-group list-group-flush"></div>
                    </div>
                </div>
                
                <!-- 阅读控制 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">阅读控制</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label">字体大小</label>
                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-secondary" id="decreaseFontBtn"><i class="fas fa-minus"></i></button>
                                <button class="btn btn-sm btn-outline-secondary" id="resetFontBtn"><i class="fas fa-sync"></i></button>
                                <button class="btn btn-sm btn-outline-secondary" id="increaseFontBtn"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-success w-100" id="toggleReadingModeBtn">
                                <i class="fas fa-book-reader"></i> 阅读模式
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary w-100" id="printReportBtn">
                                <i class="fas fa-print"></i> 打印研报
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 中间内容区 -->
        <div class="col-lg-6 col-md-8 col-sm-12 content-main">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ report.title }}</h4>
                </div>
                <div class="card-body">
                    <!-- 添加已读/未读状态和操作按钮 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            {% if report.is_read %}
                            <span class="badge bg-secondary">已读</span>
                            {% else %}
                            <span class="badge bg-primary">未读</span>
                            <a href="{{ url_for('mark_read', report_id=report.id) }}" class="btn btn-sm btn-outline-primary ms-2">
                                标记为已读
                            </a>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{{ url_for('mark_not_interested', report_id=report.id) }}" class="btn btn-sm btn-outline-secondary">
                                不再推荐类似研报
                            </a>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5>摘要</h5>
                        <p>{{ report.abstract }}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h5>研报内容</h5>
                        <div class="report-content border p-3 rounded" style="max-height: none; overflow-y: auto; white-space: pre-wrap; font-family: 'Noto Sans SC', sans-serif; font-size: 16px; line-height: 2.2; background-color: #f8f9fa; border: 1px solid #dee2e6 !important; text-indent: 2em; padding: 2rem !important; letter-spacing: 0.02em;">
                            {{ report.full_content | safe }}
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="/" class="btn btn-secondary">返回列表</a>
                    {% if report.link %}
                    <a href="{{ report.link }}" target="_blank" class="btn btn-primary">查看原文</a>
                    {% endif %}
                </div>
            </div>

            {% if not deepseek_analysis %}
            <div class="alert alert-info mb-4">
                <h5><i class="fas fa-info-circle me-2"></i>尚未进行五步法分析</h5>
                <p class="mb-2">该研报尚未进行五步法详细分析，请点击下方按钮进行分析。</p>
                <a href="/analyze/{{ report.id }}" class="btn btn-success">
                    <i class="fas fa-magic me-1"></i> 使用DeepSeek分析
                </a>
            </div>
            {% endif %}

            <!-- 我的笔记 -->
            <div class="card mt-4" id="my-notes-section">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-sticky-note me-2"></i>我的笔记
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 笔记列表 -->
                    <div id="notes-list">
                        {% if notes %}
                            {% for note in notes %}
                                <div class="note-item mb-3 p-3 border rounded" data-note-id="{{ note.id }}">
                                    <div class="note-content">{{ note.note_content | nl2br }}</div>
                                    <div class="text-muted small mt-2">
                                        创建于: {{ note.created_at.split(' ')[0] }}
                                        | 更新于: {{ note.updated_at.split(' ')[0] }}
                                        <div class="float-end">
                                            <button class="btn btn-sm btn-outline-primary edit-note-btn">编辑</button>
                                            <button class="btn btn-sm btn-outline-danger delete-note-btn">删除</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p id="no-notes-message">还没有任何笔记，快来写下你的第一条笔记吧！</p>
                        {% endif %}
                    </div>

                    <!-- 新建/编辑笔记表单 -->
                    <div class="mt-4">
                        <h6 id="note-form-title">记录新笔记</h6>
                        <textarea id="note-content-input" class="form-control" rows="4" placeholder="在此输入你的想法、疑问或总结..."></textarea>
                        <div class="mt-2 text-end">
                            <button id="save-note-btn" class="btn btn-primary">保存笔记</button>
                            <button id="update-note-btn" class="btn btn-success" style="display:none;">更新笔记</button>
                            <button id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧边栏 -->
        <div class="col-lg-3 col-md-4 sidebar-right d-none d-lg-block">
            <div class="sidebar-content" id="rightSidebar">
                <div class="d-lg-none">
                    <span class="sidebar-close" id="closeRightSidebar">&times;</span>
                </div>
                
                <!-- 分析器选择 -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">分析结果</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="nav nav-tabs" id="analyzerTabs" role="tablist">
                            {% if deepseek_analysis %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="deepseek-tab" data-bs-toggle="tab" data-bs-target="#deepseek" type="button" role="tab" aria-controls="deepseek" aria-selected="true">DeepSeek</button>
                            </li>
                            {% endif %}
                            
                            {% if not deepseek_analysis %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="no-analysis-tab" data-bs-toggle="tab" data-bs-target="#no-analysis" type="button" role="tab" aria-controls="no-analysis" aria-selected="true">暂无分析</button>
                            </li>
                            {% endif %}
                        </ul>
                        
                        <div class="tab-content p-3" id="analyzerTabsContent">
                            {% if deepseek_analysis %}
                            <div class="tab-pane fade show active" id="deepseek" role="tabpanel" aria-labelledby="deepseek-tab">
                                <!-- DeepSeek分析结果摘要 -->
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">总体评价</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>完整度评分</span>
                                            <span class="badge bg-primary">{{ deepseek_analysis.completeness_score }}</span>
                                        </div>
                                        <p class="small">{{ deepseek_analysis.one_line_summary }}</p>
                                    </div>
                                </div>
                                
                                <!-- 雷达图 -->
                                <div class="card mb-3">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">五步法雷达图</h6>
                                    </div>
                                    <div class="card-body chart-container">
                                        <canvas id="deepseekRadarChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- 改进建议 -->
                                {% if deepseek_analysis.improvement_suggestions %}
                                <div class="card mb-3">
                                    <div class="card-header bg-warning">
                                        <h6 class="mb-0">改进建议</h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush">
                                            {% for suggestion in deepseek_analysis.improvement_suggestions %}
                                                {% if suggestion.point and suggestion.suggestion and suggestion.point != '-------' and suggestion.suggestion != '----' %}
                                                <div class="list-group-item p-2">
                                                    <div class="fw-bold small">{{ suggestion.point }}</div>
                                                    <div class="small">{{ suggestion.suggestion | safe }}</div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- 视频文案生成按钮 -->
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">投资顾问口播文案</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="small">生成适合投资顾问短视频/口播使用的文案，基于五步法分析结果。</p>
                                        <div class="d-grid gap-2">
                                            <a href="/generate_video_script/{{ report.id }}" class="btn btn-info btn-sm">
                                                <i class="fas fa-video me-1"></i> 生成视频文案
                                            </a>
                                            <button type="button" class="btn btn-outline-info btn-sm" id="showVideoScript">
                                                <i class="fas fa-eye me-1"></i> 查看文案
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 查看详细分析按钮 -->
                                <button class="btn btn-outline-primary btn-sm w-100" id="showDeepseekDetails">
                                    查看详细分析 <i class="fas fa-chevron-down"></i>
                                </button>
                                
                                <!-- 详细分析 (默认隐藏) -->
                                <div class="mt-3 d-none" id="deepseekDetailsContainer">
                                    <!-- 各步骤详细分析 -->
                                    <div class="accordion" id="deepseekStepsAccordion">
                                        {% for step_name, step_data in deepseek_analysis.steps.items() %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="deepseek-heading-{{ loop.index }}">
                                                <button class="accordion-button" type="button" data-bs-target="#deepseek-collapse-{{ loop.index }}" aria-expanded="true" aria-controls="deepseek-collapse-{{ loop.index }}">
                                                    {{ step_name }} - 评分: {{ step_data.step_score }}
                                                </button>
                                            </h2>
                                            <div id="deepseek-collapse-{{ loop.index }}" class="accordion-collapse collapse show" aria-labelledby="deepseek-heading-{{ loop.index }}">
                                                <div class="accordion-body">
                                                    <p><strong>描述：</strong> {{ step_data.description | safe }}</p>
                                                    {% if step_data.framework_summary %}
                                                    <p><strong>框架梳理：</strong> {{ step_data.framework_summary | safe }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if not deepseek_analysis %}
                            <div class="tab-pane fade show active" id="no-analysis" role="tabpanel" aria-labelledby="no-analysis-tab">
                                <div class="alert alert-info">
                                    <p>该研报尚未进行五步法分析，请点击下方按钮进行分析。</p>
                                    <div class="d-grid gap-2">
                                        <a href="/analyze/{{ report.id }}" class="btn btn-success btn-sm">使用DeepSeek分析</a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 视频文案模态框 -->
<div class="modal fade" id="videoScriptModal" tabindex="-1" aria-labelledby="videoScriptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="videoScriptModalLabel">投资顾问口播文案</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i> 以下是根据五步法分析生成的投资顾问口播/短视频文案，适合直接使用或稍作修改后使用。
                </div>
                <div class="card">
                    <div class="card-body">
                        <div id="videoScriptContent" class="p-3" style="white-space: pre-wrap; line-height: 1.8;">
                            正在加载文案内容...
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-success" id="copyScriptBtn">
                        <i class="fas fa-copy me-1"></i> 复制文案
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 侧边栏控制
    const leftSidebar = document.querySelector('.sidebar-left');
    const rightSidebar = document.querySelector('.sidebar-right');
    const toggleLeftBtn = document.getElementById('toggleLeftSidebar');
    const toggleRightBtn = document.getElementById('toggleRightSidebar');
    const closeLeftBtn = document.getElementById('closeLeftSidebar');
    const closeRightBtn = document.getElementById('closeRightSidebar');
    const backdrop = document.querySelector('.sidebar-backdrop');
    const reportContent = document.querySelector('.report-content');
    
    // 显示左侧边栏
    if (toggleLeftBtn) {
        toggleLeftBtn.addEventListener('click', function() {
            leftSidebar.classList.add('show');
            document.body.classList.add('sidebar-open');
            backdrop.style.display = 'block';
        });
    }
    
    // 显示右侧边栏
    if (toggleRightBtn) {
        toggleRightBtn.addEventListener('click', function() {
            rightSidebar.classList.add('show');
            document.body.classList.add('sidebar-open');
            backdrop.style.display = 'block';
        });
    }
    
    // 关闭左侧边栏
    if (closeLeftBtn) {
        closeLeftBtn.addEventListener('click', function() {
            leftSidebar.classList.remove('show');
            document.body.classList.remove('sidebar-open');
            backdrop.style.display = 'none';
        });
    }
    
    // 关闭右侧边栏
    if (closeRightBtn) {
        closeRightBtn.addEventListener('click', function() {
            rightSidebar.classList.remove('show');
            document.body.classList.remove('sidebar-open');
            backdrop.style.display = 'none';
        });
    }
    
    // 点击背景关闭侧边栏
    if (backdrop) {
        backdrop.addEventListener('click', function() {
            leftSidebar.classList.remove('show');
            rightSidebar.classList.remove('show');
            document.body.classList.remove('sidebar-open');
            backdrop.style.display = 'none';
        });
    }
    
    // 初始化雷达图
    {% if deepseek_analysis %}
    const deepseekRadarCtx = document.getElementById('deepseekRadarChart').getContext('2d');
    const deepseekChart = new Chart(deepseekRadarCtx, {
        type: 'radar',
        data: {
            labels: ['信息', '逻辑', '超预期', '催化剂', '结论'],
            datasets: [{
                label: '五步法评分',
                data: [
                    {{ deepseek_analysis.steps.信息.step_score }},
                    {{ deepseek_analysis.steps.逻辑.step_score }},
                    {{ deepseek_analysis.steps.超预期.step_score }},
                    {{ deepseek_analysis.steps.催化剂.step_score }},
                    {{ deepseek_analysis.steps.结论.step_score }}
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            scales: {
                r: {
                    angleLines: {
                        display: true
                    },
                    suggestedMin: 0,
                    suggestedMax: 100
                }
            }
        }
    });
    {% endif %}
    
    // 字体大小控制
    const decreaseFontBtn = document.getElementById('decreaseFontBtn');
    const resetFontBtn = document.getElementById('resetFontBtn');
    const increaseFontBtn = document.getElementById('increaseFontBtn');
    const defaultFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
    
    // 减小字体
    if (decreaseFontBtn) {
        decreaseFontBtn.addEventListener('click', function() {
            const currentSize = parseFloat(getComputedStyle(reportContent).fontSize);
            reportContent.style.fontSize = (currentSize - 1) + 'px';
        });
    }
    
    // 重置字体
    if (resetFontBtn) {
        resetFontBtn.addEventListener('click', function() {
            reportContent.style.fontSize = '16px';
        });
    }
    
    // 增大字体
    if (increaseFontBtn) {
        increaseFontBtn.addEventListener('click', function() {
            const currentSize = parseFloat(getComputedStyle(reportContent).fontSize);
            reportContent.style.fontSize = (currentSize + 1) + 'px';
        });
    }
    
    // 详细分析折叠控制
    const showDeepseekDetailsBtn = document.getElementById('showDeepseekDetails');
    const deepseekDetailsContainer = document.getElementById('deepseekDetailsContainer');
    
    if (showDeepseekDetailsBtn && deepseekDetailsContainer) {
        showDeepseekDetailsBtn.addEventListener('click', function() {
            if (deepseekDetailsContainer.classList.contains('d-none')) {
                deepseekDetailsContainer.classList.remove('d-none');
                showDeepseekDetailsBtn.innerHTML = '隐藏详细分析 <i class="fas fa-chevron-up"></i>';
            } else {
                deepseekDetailsContainer.classList.add('d-none');
                showDeepseekDetailsBtn.innerHTML = '查看详细分析 <i class="fas fa-chevron-down"></i>';
            }
        });
    }
    
    // 阅读模式控制
    const toggleReadingModeBtn = document.getElementById('toggleReadingModeBtn');
    const mainContent = document.querySelector('.content-main');
    
    if (toggleReadingModeBtn && mainContent) {
        toggleReadingModeBtn.addEventListener('click', function() {
            if (mainContent.classList.contains('reading-mode')) {
                // 退出阅读模式
                mainContent.classList.remove('reading-mode');
                toggleReadingModeBtn.innerHTML = '<i class="fas fa-book-reader"></i> 阅读模式';
                // 恢复侧边栏
                leftSidebar.classList.remove('d-none');
                rightSidebar.classList.remove('d-none');
            } else {
                // 进入阅读模式
                mainContent.classList.add('reading-mode');
                toggleReadingModeBtn.innerHTML = '<i class="fas fa-times"></i> 退出阅读模式';
                // 隐藏侧边栏
                leftSidebar.classList.add('d-none');
                rightSidebar.classList.add('d-none');
            }
        });
    }
    
    // 打印研报
    const printReportBtn = document.getElementById('printReportBtn');
    
    if (printReportBtn) {
        printReportBtn.addEventListener('click', function() {
            window.print();
        });
    }
    
    // 视频文案功能
    const showVideoScriptBtn = document.getElementById('showVideoScript');
    if (showVideoScriptBtn) {
        const videoScriptModal = new bootstrap.Modal(document.getElementById('videoScriptModal'));
        const videoScriptContent = document.getElementById('videoScriptContent');
        
        showVideoScriptBtn.addEventListener('click', function() {
            // 显示加载状态
            videoScriptContent.textContent = "正在加载文案内容...";
            videoScriptModal.show();
            
            // 从API获取视频文案
            fetch(`/get_video_script/{{ report.id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.script) {
                        videoScriptContent.textContent = data.script;
                } else {
                        videoScriptContent.innerHTML = `<div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i> 
                            尚未生成视频文案，请点击"生成视频文案"按钮。
                        </div>`;
                    }
                })
                .catch(error => {
                    videoScriptContent.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        获取视频文案失败: ${error}
                    </div>`;
                });
        });
        
        // 复制文案按钮
        const copyScriptBtn = document.getElementById('copyScriptBtn');
        if (copyScriptBtn) {
            copyScriptBtn.addEventListener('click', function() {
                const scriptText = videoScriptContent.textContent;
                navigator.clipboard.writeText(scriptText)
                    .then(() => {
                        const originalText = copyScriptBtn.innerHTML;
                        copyScriptBtn.innerHTML = '<i class="fas fa-check me-1"></i> 已复制';
                        setTimeout(() => {
                            copyScriptBtn.innerHTML = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制文本');
                    });
            });
        }
    }

    // 笔记功能交互
    const reportId = {{ report.id }};
    const notesList = document.getElementById('notes-list');
    const noNotesMessage = document.getElementById('no-notes-message');
    const noteContentInput = document.getElementById('note-content-input');
    const saveNoteBtn = document.getElementById('save-note-btn');
    const updateNoteBtn = document.getElementById('update-note-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const noteFormTitle = document.getElementById('note-form-title');

    let editingNoteId = null;

    // 渲染单条笔记
    function renderNote(note) {
        const noteItem = document.createElement('div');
        noteItem.className = 'note-item mb-3 p-3 border rounded';
        noteItem.dataset.noteId = note.id;
        
        noteItem.innerHTML = `
            <div class="note-content">${note.note_content.replace(/\n/g, '<br>')}</div>
            <div class="text-muted small mt-2">
                创建于: ${note.created_at.split(' ')[0]}
                | 更新于: ${note.updated_at.split(' ')[0]}
                <div class="float-end">
                    <button class="btn btn-sm btn-outline-primary edit-note-btn">编辑</button>
                    <button class="btn btn-sm btn-outline-danger delete-note-btn">删除</button>
                </div>
            </div>
        `;
        return noteItem;
    }

    // 刷新笔记列表
    async function refreshNotes() {
        const response = await fetch(`/api/report/${reportId}/notes`);
        const notes = await response.json();
        notesList.innerHTML = ''; // 清空
        if (notes.length > 0) {
            if (noNotesMessage) noNotesMessage.style.display = 'none';
            notes.forEach(note => {
                notesList.appendChild(renderNote(note));
            });
        } else {
            if (noNotesMessage) {
                noNotesMessage.style.display = 'block';
            } else {
                const p = document.createElement('p');
                p.id = 'no-notes-message';
                p.textContent = '还没有任何笔记，快来写下你的第一条笔记吧！';
                notesList.appendChild(p);
            }
        }
    }

    // 保存新笔记
    saveNoteBtn.addEventListener('click', async () => {
        const content = noteContentInput.value.trim();
        if (!content) {
            showToast('笔记内容不能为空', 'warning');
            return;
        }

        const response = await fetch(`/api/report/${reportId}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ note_content: content })
        });

        if (response.ok) {
            noteContentInput.value = '';
            showToast('笔记保存成功', 'success');
            await refreshNotes();
        } else {
            showToast('保存失败，请稍后重试', 'danger');
        }
    });

    // 处理编辑和删除事件
    notesList.addEventListener('click', async (e) => {
        const target = e.target;
        const noteItem = target.closest('.note-item');
        if (!noteItem) return;
        const noteId = noteItem.dataset.noteId;

        // 删除笔记
        if (target.classList.contains('delete-note-btn')) {
            if (confirm('确定要删除这条笔记吗？此操作不可撤销。')) {
                const response = await fetch(`/api/notes/${noteId}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('笔记已删除', 'success');
                    await refreshNotes();
                } else {
                    showToast('删除失败', 'danger');
                }
            }
        }

        // 编辑笔记
        if (target.classList.contains('edit-note-btn')) {
            const contentDiv = noteItem.querySelector('.note-content');
            noteContentInput.value = contentDiv.innerText; // 使用 innerText 获取纯文本内容
            editingNoteId = noteId;

            noteFormTitle.textContent = '编辑笔记';
            saveNoteBtn.style.display = 'none';
            updateNoteBtn.style.display = 'inline-block';
            cancelEditBtn.style.display = 'inline-block';
            noteContentInput.focus();
        }
    });

    // 更新笔记
    updateNoteBtn.addEventListener('click', async () => {
        const content = noteContentInput.value.trim();
        if (!content) {
            showToast('笔记内容不能为空', 'warning');
            return;
        }

        const response = await fetch(`/api/notes/${editingNoteId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ note_content: content })
        });

        if (response.ok) {
            showToast('笔记更新成功', 'success');
            await refreshNotes();
            resetNoteForm();
        } else {
            showToast('更新失败', 'danger');
        }
    });

    // 取消编辑
    cancelEditBtn.addEventListener('click', () => {
        resetNoteForm();
    });

    function resetNoteForm() {
        editingNoteId = null;
        noteContentInput.value = '';
        noteFormTitle.textContent = '记录新笔记';
        saveNoteBtn.style.display = 'inline-block';
        updateNoteBtn.style.display = 'none';
        cancelEditBtn.style.display = 'none';
    }
});
</script>

<style>
.card {
    border-radius: 8px;
    overflow: hidden;
}

.radar-chart-container {
    position: relative;
    height: 250px;
    width: 100%;
}

.content-preview {
    max-height: 500px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.5;
    background-color: #f9f9f9;
    border-radius: 5px;
    padding: 10px;
}

.card-header .btn-light {
    border: none;
    background-color: rgba(255, 255, 255, 0.3);
    color: white;
}

.card-header .btn-light:hover {
    background-color: rgba(255, 255, 255, 0.5);
}

/* 五步法卡片特殊颜色 */
.text-primary {
    color: #007bff !important;
}
.text-success {
    color: #28a745 !important;
}
.text-warning {
    color: #ffc107 !important;
}
.text-info {
    color: #17a2b8 !important;
}
.text-danger {
    color: #dc3545 !important;
}

/* 添加卡片阴影动效 */
.shadow-sm {
    transition: box-shadow 0.3s ease, transform 0.3s ease;
}
.shadow-sm:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
}

/* 研报内容样式优化 */
.report-content {
    font-family: 'Noto Sans SC', sans-serif;
    color: #333;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.3s ease;
}

.report-content:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
}

/* 阅读模式样式 */
.reading-mode {
    max-height: none !important;
    font-size: 18px !important;
    line-height: 2.5 !important;
    background-color: #f9f9fb !important;
    color: #2c3e50 !important;
    padding: 3rem !important;
    text-indent: 2em !important;
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1) !important;
    border-radius: 8px !important;
    width: 100% !important;
    margin: 0 auto !important;
    letter-spacing: 0.03em !important;
}

.reading-mode p {
    margin-bottom: 3em !important;
}

.reading-mode br + br {
    margin-top: 2.5em !important;
}

/* 目录样式 */
#toc .list-group-item {
    padding: 0.5rem 1rem;
    font-size: 14px;
    border-left: 3px solid transparent;
}

#toc .list-group-item:hover {
    background-color: #f8f9fa;
    border-left: 3px solid #007bff;
}

/* 段落样式 */
.report-content p {
    margin-bottom: 2em;
}

/* 增加段落间距 */
.report-content {
    line-height: 2.2;
}

.report-content > * {
    margin-bottom: 2em;
}

/* 空行处理 */
.report-content br + br {
    display: block;
    content: "";
    margin-top: 1.5em;
}

/* 数字列表项样式 */
.report-content p:first-child:contains("1)"),
.report-content p:first-child:contains("2)"),
.report-content p:first-child:contains("3)") {
    margin-top: 2em;
    margin-bottom: 2em;
    padding-left: 1em;
    border-left: 3px solid #e9ecef;
}

/* 投资要点等标题样式 */
.report-content p:contains("投资要点"),
.report-content p:contains("行业动向"),
.report-content p:contains("公司概况"),
.report-content p:contains("风险提示") {
    font-weight: bold;
    font-size: 1.2em;
    margin-top: 2.5em;
    margin-bottom: 1.5em;
    padding-bottom: 0.5em;
    border-bottom: 1px solid #e9ecef;
}

/* 表格样式 */
.report-content table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1em;
}

.report-content table, .report-content th, .report-content td {
    border: 1px solid #ddd;
}

.report-content th, .report-content td {
    padding: 8px;
    text-align: left;
}

.report-content th {
    background-color: #f2f2f2;
}

/* 字体控制按钮样式 */
.font-size-controls .btn {
    margin-right: 5px;
}

/* 打印按钮样式 */
#printReportBtn {
    transition: all 0.2s ease;
}

#printReportBtn:hover {
    background-color: #0069d9;
    color: white;
}
</style>

<!-- 添加用于记录阅读时长的JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 页面加载时记录开始时间
    var startTime = new Date();
    var reportId = "{{ report.id }}";
    var readDuration = 0;
    var updateInterval;
    
    // 初始记录（5秒后记录一次，确保短时间浏览也能捕获）
    setTimeout(function() {
        var currentTime = new Date();
        readDuration = Math.floor((currentTime - startTime) / 1000); // 转换为秒
        console.log("初始阅读时长记录: " + readDuration + "秒");
        
        // 发送AJAX请求更新阅读时长
        updateReadingDuration(readDuration);
    }, 5000); // 5秒后记录一次
    
    // 定期更新阅读时长（每30秒更新一次）
    updateInterval = setInterval(function() {
        var currentTime = new Date();
        readDuration = Math.floor((currentTime - startTime) / 1000); // 转换为秒
        console.log("更新阅读时长: " + readDuration + "秒");
        
        // 发送AJAX请求更新阅读时长
        updateReadingDuration(readDuration);
    }, 30000); // 每30秒更新一次
    
    // 页面关闭或离开时更新阅读记录
    window.addEventListener('beforeunload', function() {
        clearInterval(updateInterval);
        var endTime = new Date();
        readDuration = Math.floor((endTime - startTime) / 1000); // 转换为秒
        
        // 发送同步请求，确保在页面关闭前完成
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/update_reading_duration/' + reportId, false); // 同步请求
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({
            duration: readDuration,
            is_completed: true
        }));
    });
    
    // 异步更新阅读时长的函数
    function updateReadingDuration(duration) {
        fetch('/update_reading_duration/' + reportId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                duration: duration,
                is_completed: false // 定期更新时不标记为已完成
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            console.log('成功更新阅读时长:', data);
        })
        .catch(error => {
            console.error('更新阅读时长失败:', error);
        });
    }
});
</script>
{% endblock %}
